<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue 3 èŠå¤©åº”ç”¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      background-color: #f0f2f5;
      height: 100vh;
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      height: 100vh;
    }
    
    /* å·¦ä¾§è”ç³»äººåˆ—è¡¨ */
    .contact-list {
      width: 280px;
      background-color: #fafafa;
      border-right: 1px solid #e5e5e5;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .search-container {
      padding: 15px;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }
    
    .search-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .contacts {
      flex: 1;
      overflow-y: auto;
    }
    
    .contact-item {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .contact-item:hover {
      background-color: #f0f0f0;
    }
    
    .contact-item.active {
      background-color: #e6f7ff;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      background-color: #e1e1e1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .contact-info {
      flex: 1;
    }
    
    .contact-name {
      font-size: 15px;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .last-message {
      font-size: 13px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .time {
      font-size: 12px;
      color: #999;
      margin-left: 8px;
    }
    
    /* ä¸­é—´èŠå¤©åŒºåŸŸ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e5e5e5;
      background-color: #fff;
    }
    
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #e5e5e5;
      display: flex;
      align-items: center;
      background: #fff;
      height: 60px;
    }
    
    .chat-title {
      font-size: 16px;
      font-weight: 500;
    }
    
    .message-container {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #f5f5f5;
    }
    
    .message {
      margin-bottom: 15px;
      display: flex;
    }
    
    .message.incoming {
      flex-direction: row;
    }
    
    .message.outgoing {
      flex-direction: row-reverse;
    }
    
    .message-content {
      padding: 10px 15px;
      border-radius: 4px;
      max-width: 70%;
      position: relative;
      word-break: break-word;
    }
    
    .incoming .message-content {
      background-color: #fff;
      margin-left: 10px;
      border-top-left-radius: 0;
    }
    
    .outgoing .message-content {
      background-color: #95ec69;
      margin-right: 10px;
      border-top-right-radius: 0;
    }
    
    .message-time {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
      text-align: right;
    }
    
    .message-input {
      padding: 15px;
      border-top: 1px solid #e5e5e5;
      background-color: #fff;
    }
    
    .input-container {
      display: flex;
      align-items: center;
    }
    
    .emoji-button {
      margin-right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #888;
      position: relative;
    }
    
    .emoji-picker-container {
      position: absolute;
      bottom: 40px;
      left: 0;
      z-index: 100;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 300px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .emoji-item {
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .emoji-item:hover {
      background-color: #f0f0f0;
    }
    
    .file-button {
      margin-right: 10px;
      font-size: 18px;
      cursor: pointer;
      color: #888;
    }
    .text-input-container{
      width: 100%;
    }
    .text-input {
      width: 100%;
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: none;
      height: 80px;
      font-family: inherit;
      font-size: 14px;
    }
    
    .send-button {
      margin-left: 10px;
      padding: 8px 20px;
      background-color: #1aad19;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .send-button:disabled {
      background-color: #9fd09e;
      cursor: not-allowed;
    }
    
    /* å³ä¾§è¯¦æƒ…åŒºåŸŸ */
    .detail-panel {
      width: 280px;
      background-color: #fafafa;
      overflow-y: auto;
    }
    
    .detail-header {
      padding: 20px 15px;
      border-bottom: 1px solid #e5e5e5;
      text-align: center;
    }
    
    .detail-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background-color: #e1e1e1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .detail-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .detail-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .detail-id {
      font-size: 14px;
      color: #666;
    }
    
    .detail-section {
      padding: 15px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .section-title {
      font-size: 14px;
      color: #888;
      margin-bottom: 15px;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .item-icon {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      color: #888;
    }
    
    .item-text {
      font-size: 14px;
      flex: 1;
    }
    
    /* æœç´¢ç©ºç»“æœæ ·å¼ */
    .empty-search {
      padding: 30px 20px;
      text-align: center;
      color: #999;
    }
    
    .empty-search-icon {
      font-size: 40px;
      margin-bottom: 10px;
      color: #ddd;
    }
    
    /* æ–‡ä»¶ä¸Šä¼ ç›¸å…³æ ·å¼ */
    .file-upload {
      display: none;
    }
    
    .upload-preview {
      display: flex;
      flex-wrap: wrap;
      padding: 5px;
      margin-top: 5px;
      gap: 5px;
    }
    
    .upload-item {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    
    .upload-item img, .upload-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .upload-item.file {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f8f8f8;
      font-size: 24px;
      color: #999;
    }
    
    .upload-remove {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 18px;
      height: 18px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
    }
    
    .message-file {
      display: flex;
      align-items: center;
      background-color: #f8f8f8;
      padding: 8px;
      border-radius: 4px;
      margin-top: 5px;
    }
    
    .message-file-icon {
      font-size: 24px;
      margin-right: 10px;
      color: #666;
    }
    
    .message-file-info {
      flex: 1;
    }
    
    .message-file-name {
      font-size: 14px;
      margin-bottom: 2px;
    }
    
    .message-file-size {
      font-size: 12px;
      color: #999;
    }
    
    .message-file-download {
      color: #1aad19;
      font-size: 12px;
      cursor: pointer;
    }
    
    .message-media {
      margin-top: 5px;
      max-width: 200px;
    }
    
    .message-image {
      max-width: 100%;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .message-video {
      max-width: 100%;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-container">
      <!-- å·¦ä¾§è”ç³»äººåˆ—è¡¨ -->
      <div class="contact-list">
        <div class="search-container">
          <input type="text" class="search-input" placeholder="æœç´¢" v-model="searchQuery">
        </div>
        <div class="contacts">
          <template v-if="filteredContacts.length > 0">
            <div 
              v-for="(contact, index) in filteredContacts" 
              :key="contact.id" 
              class="contact-item" 
              :class="{ active: activeContactId === contact.id }"
              @click="selectContact(contact.id)">
              <div class="avatar">
                <img :src="contact.avatar" :alt="contact.name">
              </div>
              <div class="contact-info">
                <div class="contact-name">{{ contact.name }}</div>
                <div class="last-message">{{ contact.lastMessage }}</div>
              </div>
              <div class="time">{{ contact.lastTime }}</div>
            </div>
          </template>
          <div v-else class="empty-search">
            <div class="empty-search-icon">ğŸ”</div>
            <div>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è”ç³»äºº</div>
          </div>
        </div>
      </div>
      
      <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
      <div class="chat-area" v-if="activeContact">
        <div class="chat-header">
          <div class="chat-title">{{ activeContact.name }}</div>
        </div>
        <div class="message-container" ref="messageContainer">
          <div 
            v-for="(message, index) in activeContact.messages" 
            :key="index" 
            class="message" 
            :class="message.outgoing ? 'outgoing' : 'incoming'">
            <div class="avatar" v-if="!message.outgoing">
              <img :src="activeContact.avatar" :alt="activeContact.name">
            </div>
            <div class="message-content">
              {{ message.content }}
              
              <!-- å¦‚æœæ˜¯å›¾ç‰‡æ¶ˆæ¯ -->
              <div v-if="message.image" class="message-media">
                <img :src="message.image" alt="å›¾ç‰‡" class="message-image" @click="previewMedia(message.image)">
              </div>
              
              <!-- å¦‚æœæ˜¯è§†é¢‘æ¶ˆæ¯ -->
              <div v-if="message.video" class="message-media">
                <video :src="message.video" class="message-video" controls></video>
              </div>
              
              <!-- å¦‚æœæ˜¯æ–‡ä»¶æ¶ˆæ¯ -->
              <div v-if="message.file" class="message-file">
                <div class="message-file-icon">ğŸ“„</div>
                <div class="message-file-info">
                  <div class="message-file-name">{{ message.fileName }}</div>
                  <div class="message-file-size">{{ message.fileSize }}</div>
                </div>
                <div class="message-file-download">ä¸‹è½½</div>
              </div>
              
              <div class="message-time">{{ message.time }}</div>
            </div>
            <div class="avatar" v-if="message.outgoing">
              <img src="https://via.placeholder.com/40" alt="æˆ‘">
            </div>
          </div>
        </div>
        <div class="message-input">
          <div class="input-container">
            <div class="emoji-button" @click="toggleEmojiPicker">ğŸ˜Š</div>
            <div class="emoji-picker-container" v-if="showEmojiPicker" @click.stop>
              <div v-for="(emoji, index) in emojiList" :key="index" class="emoji-item" @click="selectEmoji(emoji)">
                {{ emoji }}
              </div>
            </div>
            <div class="file-button" @click="triggerFileUpload">ğŸ“</div>
            <input 
              type="file" 
              class="file-upload" 
              ref="fileInput"
              @change="handleFileUpload"
              multiple
              accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt">
            <div class="text-input-container">
              <textarea 
                class="text-input" 
                v-model="newMessage" 
                @keyup.enter="sendMessage"
                placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
              <div v-if="uploadFiles.length > 0" class="upload-preview">
                <div v-for="(file, index) in uploadFiles" :key="index" class="upload-item" :class="{file: !isImageOrVideo(file.file)}">
                  <template v-if="isImage(file.file)">
                    <img :src="file.url" alt="å›¾ç‰‡é¢„è§ˆ" />
                  </template>
                  <template v-else-if="isVideo(file.file)">
                    <video :src="file.url" preload="metadata"></video>
                  </template>
                  <template v-else>
                    ğŸ“„
                  </template>
                  <div class="upload-remove" @click.stop="removeUploadFile(index)">x</div>
                </div>
              </div>
            </div>
            <button class="send-button" @click="sendMessage" :disabled="!canSendMessage">å‘é€</button>
          </div>
        </div>
      </div>
      <div class="chat-area" v-else>
        <div class="empty-chat">
          <p>è¯·é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</p>
        </div>
      </div>
      
      <!-- å³ä¾§è¯¦æƒ…åŒºåŸŸ -->
      <div class="detail-panel" v-if="activeContact">
        <div class="detail-header">
          <div class="detail-avatar">
            <img :src="activeContact.avatar" :alt="activeContact.name">
          </div>
          <div class="detail-name">{{ activeContact.name }}</div>
          <div class="detail-id">ID: {{ activeContact.id }}</div>
        </div>
        
        <div class="detail-section">
          <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div class="detail-item">
            <div class="item-icon">ğŸ‘¤</div>
            <div class="item-text">æ˜µç§°: {{ activeContact.name }}</div>
          </div>
          <div class="detail-item">
            <div class="item-icon">ğŸ”–</div>
            <div class="item-text">å¤‡æ³¨: {{ activeContact.remark || 'æ— ' }}</div>
          </div>
          <div class="detail-item">
            <div class="item-icon">ğŸ“±</div>
            <div class="item-text">æ‰‹æœº: {{ activeContact.phone || 'æœªè®¾ç½®' }}</div>
          </div>
        </div>
        
        <div class="detail-section">
          <div class="section-title">èŠå¤©è®°å½•</div>
          <div class="detail-item">
            <div class="item-icon">ğŸ”</div>
            <div class="item-text">æŸ¥æ‰¾èŠå¤©è®°å½•</div>
          </div>
          <div class="detail-item">
            <div class="item-icon">ğŸ“‚</div>
            <div class="item-text">æŸ¥çœ‹å›¾ç‰‡å’Œæ–‡ä»¶</div>
          </div>
        </div>
        
        <div class="detail-section">
          <div class="section-title">è®¾ç½®</div>
          <div class="detail-item">
            <div class="item-icon">ğŸ”•</div>
            <div class="item-text">æ¶ˆæ¯å…æ‰“æ‰°</div>
          </div>
          <div class="detail-item">
            <div class="item-icon">ğŸ“Œ</div>
            <div class="item-text">ç½®é¡¶èŠå¤©</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  
  <script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;
    
    createApp({
      setup() {
        // è·å–æœ¬åœ°å­˜å‚¨æ•°æ®
        const savedContacts = localStorage.getItem('chatContacts');
        const savedActiveContactId = localStorage.getItem('activeContactId');
        // è”ç³»äººæ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„æ•°æ®
        const contacts = ref(savedContacts ? JSON.parse(savedContacts) : [
          {
            id: 1,
            name: 'å¼ ä¸‰',
            avatar: 'https://via.placeholder.com/40/3498db/ffffff?text=å¼ ',
            lastMessage: 'æœ€è¿‘åœ¨å¿™ä»€ä¹ˆå‘¢ï¼Ÿ',
            lastTime: '10:23',
            remark: 'å¤§å­¦åŒå­¦',
            phone: '13800138000',
            messages: [
              {
                content: 'ä½ å¥½ï¼Œæœ€è¿‘åœ¨å¹²ä»€ä¹ˆå‘¢ï¼Ÿ',
                time: 'æ˜¨å¤© 15:30',
                outgoing: false
              },
              {
                content: 'åœ¨å¿™é¡¹ç›®ï¼Œä½ å‘¢ï¼Ÿ',
                time: 'æ˜¨å¤© 15:35',
                outgoing: true
              },
              {
                content: 'æˆ‘ä¹Ÿåœ¨å¿™å·¥ä½œï¼Œä¸‹å‘¨æœ‰ç©ºä¸€èµ·åƒé¥­å§',
                time: 'æ˜¨å¤© 15:40',
                outgoing: false
              },
              {
                content: 'å¥½å•Šï¼Œåˆ°æ—¶å€™å†è”ç³»',
                time: 'æ˜¨å¤© 15:42',
                outgoing: true
              },
              {
                content: 'æœ€è¿‘åœ¨å¿™ä»€ä¹ˆå‘¢ï¼Ÿ',
                time: 'ä»Šå¤© 10:23',
                outgoing: false
              }
            ]
          },
          {
            id: 2,
            name: 'æå››',
            avatar: 'https://via.placeholder.com/40/e74c3c/ffffff?text=æ',
            lastMessage: 'åˆ«å¿˜äº†ä¸‹å‘¨ä¸€çš„ä¼šè®®',
            lastTime: 'æ˜¨å¤©',
            remark: 'é¡¹ç›®ç»ç†',
            phone: '13900139000',
            messages: [
              {
                content: 'åˆ«å¿˜äº†ä¸‹å‘¨ä¸€çš„ä¼šè®®',
                time: 'æ˜¨å¤© 18:30',
                outgoing: false
              }
            ]
          },
          {
            id: 3,
            name: 'ç‹äº”',
            avatar: 'https://via.placeholder.com/40/2ecc71/ffffff?text=ç‹',
            lastMessage: 'æ”¶åˆ°æ–‡ä»¶äº†å—ï¼Ÿ',
            lastTime: 'ä¸Šå‘¨',
            remark: 'äº§å“è®¾è®¡å¸ˆ',
            phone: '13700137000',
            messages: [
              {
                content: 'æˆ‘å‘äº†ä¸€ä»½è®¾è®¡æ–‡ä»¶ç»™ä½ ',
                time: 'ä¸Šå‘¨ä¸‰ 14:20',
                outgoing: false
              },
              {
                content: 'æ”¶åˆ°äº†ï¼Œæˆ‘å·²ç»åœ¨çœ‹äº†',
                time: 'ä¸Šå‘¨ä¸‰ 14:25',
                outgoing: true
              },
              {
                content: 'æœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼Œæˆ‘ç¨åå‘åé¦ˆç»™ä½ ',
                time: 'ä¸Šå‘¨ä¸‰ 14:30',
                outgoing: true
              },
              {
                content: 'å¥½çš„ï¼Œæˆ‘ç­‰ä½ çš„åé¦ˆ',
                time: 'ä¸Šå‘¨ä¸‰ 14:35',
                outgoing: false
              },
              {
                content: 'æ”¶åˆ°æ–‡ä»¶äº†å—ï¼Ÿ',
                time: 'ä¸Šå‘¨äº” 09:30',
                outgoing: false
              }
            ]
          },
          {
            id: 4,
            name: 'å°ç»„ç¾¤',
            avatar: 'https://via.placeholder.com/40/9b59b6/ffffff?text=ç»„',
            lastMessage: 'å°æ: å¤§å®¶è®°å¾—å‡†æ—¶æäº¤å‘¨æŠ¥',
            lastTime: '08:53',
            remark: 'é¡¹ç›®ç»„',
            phone: '',
            messages: [
              {
                content: 'å°æ: å¤§å®¶å¥½ï¼Œä»Šå¤©ä¸‹åˆå››ç‚¹å¼€ä¼š',
                time: 'æ˜¨å¤© 08:30',
                outgoing: false
              },
              {
                content: 'å°ç‹: æ”¶åˆ°',
                time: 'æ˜¨å¤© 08:35',
                outgoing: false
              },
              {
                content: 'å¥½çš„ï¼Œæˆ‘ä¼šå‡†æ—¶å‚åŠ ',
                time: 'æ˜¨å¤© 08:40',
                outgoing: true
              },
              {
                content: 'å°æ: å¤§å®¶è®°å¾—å‡†æ—¶æäº¤å‘¨æŠ¥',
                time: 'ä»Šå¤© 08:53',
                outgoing: false
              }
            ]
          },
          {
            id: 5,
            name: 'åˆ˜å…­',
            avatar: 'https://via.placeholder.com/40/f1c40f/ffffff?text=åˆ˜',
            lastMessage: 'å‘¨æœ«æœ‰ç©ºä¸€èµ·æ‰“çƒå—ï¼Ÿ',
            lastTime: 'å‰å¤©',
            remark: 'ç¯®çƒä¼™ä¼´',
            phone: '13600136000',
            messages: [
              {
                content: 'å‘¨æœ«æœ‰ç©ºä¸€èµ·æ‰“çƒå—ï¼Ÿ',
                time: 'å‰å¤© 20:30',
                outgoing: false
              }
            ]
          }
        ]);
        
        const searchQuery = ref('');
        const activeContactId = ref(savedActiveContactId ? parseInt(savedActiveContactId) : null);
        const newMessage = ref('');
        const showEmojiPicker = ref(false);
        const uploadFiles = ref([]);
        const fileInput = ref(null);
        
        // é¢„è®¾è¡¨æƒ…åˆ—è¡¨
        const emojiList = ref([
          'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‡', 
          'ğŸ˜ˆ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜', 
          'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ˜–', 'ğŸ˜—', 
          'ğŸ˜˜', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜Ÿ', 
          'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜£', 'ğŸ˜¤', 'ğŸ˜¥', 'ğŸ˜¦', 'ğŸ˜§',
          'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ˜·', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ™„', 
          'â¤ï¸', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘‘',
          'ğŸ‰', 'ğŸ„', 'ğŸƒ', 'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°'
        ]);
        
        // æ ¹æ®æœç´¢è¿‡æ»¤è”ç³»äºº
        const filteredContacts = computed(() => {
          if (!searchQuery.value) return contacts.value;
          
          return contacts.value.filter(contact => 
            contact.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
            (contact.remark && contact.remark.toLowerCase().includes(searchQuery.value.toLowerCase()))
          );
        });
        
        // è·å–å½“å‰é€‰ä¸­çš„è”ç³»äºº
        const activeContact = computed(() => {
          if (!activeContactId.value) return null;
          return contacts.value.find(contact => contact.id === activeContactId.value);
        });
        
        // æ¶ˆæ¯å®¹å™¨å¼•ç”¨ï¼Œç”¨äºæ»šåŠ¨
        const messageContainer = ref(null);
        
        // é€‰æ‹©è”ç³»äºº
        function selectContact(id) {
          activeContactId.value = id;
          
          // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
          nextTick(() => {
            scrollToBottom();
          });
        }
        
        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å‡½æ•°
        function triggerFileUpload() {
          fileInput.value.click();
        }
        
        function handleFileUpload(event) {
          const files = event.target.files;
          if (!files.length) return;
          
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const url = URL.createObjectURL(file);
            uploadFiles.value.push({
              file,
              url,
              type: file.type,
              name: file.name,
              size: formatFileSize(file.size)
            });
          }
          
          // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸å†æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
          event.target.value = '';
        }
        
        function removeUploadFile(index) {
          if (uploadFiles.value[index].url) {
            URL.revokeObjectURL(uploadFiles.value[index].url);
          }
          uploadFiles.value.splice(index, 1);
        }
        
        function isImage(file) {
          return file.type.startsWith('image/');
        }
        
        function isVideo(file) {
          return file.type.startsWith('video/');
        }
        
        function isImageOrVideo(file) {
          return isImage(file) || isVideo(file);
        }
        
        function formatFileSize(bytes) {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function previewMedia(url) {
          // åœ¨è¿™é‡Œå¯ä»¥å®ç°å…¨å±é¢„è§ˆåŠŸèƒ½
          window.open(url, '_blank');
        }
        
        const canSendMessage = computed(() => {
          return (newMessage.value.trim() !== '' || uploadFiles.value.length > 0) && activeContactId.value !== null;
        });
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
          if (!canSendMessage.value) return;
          
          const contact = contacts.value.find(c => c.id === activeContactId.value);
          
          if (contact) {
            // æ·»åŠ æ–°æ¶ˆæ¯
            const now = new Date();
            const messageObj = {
              content: newMessage.value.trim(),
              timestamp: now.getTime(),
              time: formatMessageTime(now),
              outgoing: true
            };
            
            // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
            uploadFiles.value.forEach(file => {
              if (isImage(file.file)) {
                messageObj.image = file.url;
              } else if (isVideo(file.file)) {
                messageObj.video = file.url;
              } else {
                messageObj.file = file.url;
                messageObj.fileName = file.name;
                messageObj.fileSize = file.size;
              }
            });
            
            contact.messages.push(messageObj);
            
            // æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯
            contact.lastMessage = newMessage.value;
            contact.lastTime = 'åˆšåˆš';
            
            // æ¸…ç©ºè¾“å…¥å’Œæ–‡ä»¶
            newMessage.value = '';
            uploadFiles.value = [];
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            nextTick(() => {
              scrollToBottom();
            });
            
            // æ¨¡æ‹Ÿè‡ªåŠ¨å›å¤
            setTimeout(() => {
              const autoResponses = [
                'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†',
                'æ”¶åˆ°',
                'ç¨ç­‰ï¼Œæˆ‘å¤„ç†ä¸€ä¸‹',
                'è°¢è°¢ä½ çš„ä¿¡æ¯',
                'ç•™è¨€æ”¶åˆ°ï¼Œæˆ‘ç¨åå›å¤ä½ '
              ];
              
              const randomResponse = autoResponses[Math.floor(Math.random() * autoResponses.length)];
              const responseTime = new Date();
              
              contact.messages.push({
                content: randomResponse,
                timestamp: responseTime.getTime(),
                time: formatMessageTime(responseTime),
                outgoing: false
              });
              
              contact.lastMessage = randomResponse;
              
              nextTick(() => {
                scrollToBottom();
              });
            }, 1000);
          }
        }
        
        // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨æ˜¾ç¤ºçŠ¶æ€
        function toggleEmojiPicker() {
          showEmojiPicker.value = !showEmojiPicker.value;
        }
        
        // é€‰æ‹©è¡¨æƒ…
        function selectEmoji(emoji) {
          newMessage.value += emoji;
          showEmojiPicker.value = false;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´
        function formatMessageTime(date, isRealtime = false) {
          if (!(date instanceof Date)) {
            date = new Date(date);
          }
          
          const now = new Date();
          const diffSeconds = Math.floor((now - date) / 1000);
          
          // å°äº10ç§’ï¼šæ˜¾ç¤ºâ€œåˆšåˆšâ€
          if (diffSeconds < 10) {
            return 'åˆšåˆš';
          }
          
          // å°äº1åˆ†é’Ÿï¼šæ˜¾ç¤ºnç§’
          if (diffSeconds < 60) {
            return `${diffSeconds}ç§’`;
          }
          
          const diffMinutes = Math.floor(diffSeconds / 60);
          
          // å°äº1å°æ—¶ï¼šæ˜¾ç¤ºnåˆ†é’Ÿ
          if (diffMinutes < 60) {
            return `${diffMinutes}åˆ†é’Ÿ`;
          }
          
          const diffHours = Math.floor(diffMinutes / 60);
          const sameDay = (
            date.getDate() === now.getDate() && 
            date.getMonth() === now.getMonth() && 
            date.getFullYear() === now.getFullYear()
          );
          
          // å°äº24å°æ—¶ä¸”æ˜¯å½“å¤©ï¼šæ˜¾ç¤ºâ€œnå°æ—¶â€
          if (diffHours < 24 && sameDay) {
            return `${diffHours}å°æ—¶`;
          }
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜¨å¤©
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const isYesterday = (
            date.getDate() === yesterday.getDate() && 
            date.getMonth() === yesterday.getMonth() && 
            date.getFullYear() === yesterday.getFullYear()
          );
          
          // æ˜¯æ˜¨å¤©ï¼šæ˜¾ç¤ºâ€œæ˜¨å¤© HH:MMâ€
          if (isYesterday) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `æ˜¨å¤© ${hours}:${minutes}`;
          }
          
          // æ›´æ—©çš„æ—¶é—´ï¼šæ˜¾ç¤ºâ€œMM-DD HH:MMâ€
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const day = date.getDate().toString().padStart(2, '0');
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          
          return `${month}-${day} ${hours}:${minutes}`;
        }
        
        // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯æ—¶é—´æ˜¾ç¤º
        function updateAllMessageTimes() {
          contacts.value.forEach(contact => {
            contact.messages.forEach(message => {
              if (message.timestamp) {
                message.time = formatMessageTime(message.timestamp);
              }
            });
          });
        }
        
        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ¶ˆæ¯æ—¶é—´æ˜¾ç¤º
        setInterval(updateAllMessageTimes, 60000);
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­è¡¨æƒ…é€‰æ‹©å™¨
        function closeEmojiPicker(event) {
          if (showEmojiPicker.value && !event.target.closest('.emoji-picker-container') && !event.target.closest('.emoji-button')) {
            showEmojiPicker.value = false;
          }
        }
        
        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        function scrollToBottom() {
          if (messageContainer.value) {
            messageContainer.value.scrollTop = messageContainer.value.scrollHeight;
          }
        }
        
        // ç›‘å¬è”ç³»äººå˜åŒ–ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        watch(contacts, (newContacts) => {
          localStorage.setItem('chatContacts', JSON.stringify(newContacts));
        }, { deep: true });
        
        // ç›‘å¬å½“å‰é€‰ä¸­çš„è”ç³»äººå˜åŒ–
        watch(activeContactId, (newId) => {
          localStorage.setItem('activeContactId', newId);
        });
        
        // åˆå§‹åŒ–æ—¶é€‰æ‹©ç¬¬ä¸€ä¸ªè”ç³»äºº
        onMounted(() => {
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼Œå…³é—­è¡¨æƒ…é€‰æ‹©å™¨
          document.addEventListener('click', closeEmojiPicker);
          
          if (contacts.value.length > 0) {
            selectContact(contacts.value[0].id);
          }
        });
        
        return {
          contacts,
          searchQuery,
          filteredContacts,
          activeContactId,
          activeContact,
          newMessage,
          messageContainer,
          selectContact,
          sendMessage,
          showEmojiPicker,
          toggleEmojiPicker,
          selectEmoji,
          emojiList,
          uploadFiles,
          fileInput,
          triggerFileUpload,
          handleFileUpload,
          removeUploadFile,
          isImage,
          isVideo,
          isImageOrVideo,
          previewMedia,
          canSendMessage
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
